generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         UserRole
  phone        String?
  isVerified   Boolean   @default(false) @map("is_verified")
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  profile         UserProfile?
  providerProfile ProviderProfile?
  requests        Request[]
  sentReviews     Review[]           @relation("ReviewSender")
  receivedReviews Review[]           @relation("ReviewReceiver")
  notifications   Notification[]
  conversations1  ChatConversation[] @relation("Participant1")
  conversations2  ChatConversation[] @relation("Participant2")
  sentMessages    ChatMessage[]
  transactions    Transaction[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  CLIENT
  PROVIDER
  ADMIN
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  avatarUrl String?  @map("avatar_url")
  address   String?
  city      String?
  state     String?
  country   String   @default("Peru")
  zipCode   String?  @map("zip_code")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

model ProviderProfile {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  businessName       String    @map("business_name")
  description        String?
  yearsExperience    Int       @default(0) @map("years_experience")
  avatarUrl          String?   @map("avatar_url")
  coverImageUrl      String?   @map("cover_image_url")
  city               String?
  state              String?
  country            String    @default("Peru")
  serviceRadius      Int       @default(50) @map("service_radius")
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)
  isPremium          Boolean   @default(false) @map("is_premium")
  premiumUntil       DateTime? @map("premium_until")
  ratingAverage      Decimal   @default(0.00) @map("rating_average") @db.Decimal(3, 2)
  totalReviews       Int       @default(0) @map("total_reviews")
  totalJobsCompleted Int       @default(0) @map("total_jobs_completed")
  responseRate       Decimal   @default(0.00) @map("response_rate") @db.Decimal(5, 2)
  responseTimeHours  Decimal   @default(0.00) @map("response_time_hours") @db.Decimal(5, 2)
  stripeAccountId    String?   @map("stripe_account_id")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  servicesOffered ServiceOffered[]
  portfolioItems  PortfolioItem[]
  certifications  Certification[]
  proposals       RequestProposal[]
  transactions    Transaction[]
  subscriptions   Subscription[]
  savedRequests   SavedRequest[]

  @@index([userId])
  @@index([city])
  @@index([ratingAverage])
  @@map("provider_profiles")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  iconUrl     String?  @map("icon_url")
  isActive    Boolean  @default(true) @map("is_active")
  parentId    String?  @map("parent_id")
  createdAt   DateTime @default(now()) @map("created_at")

  parent          Category?        @relation("SubCategories", fields: [parentId], references: [id])
  children        Category[]       @relation("SubCategories")
  requests        Request[]
  servicesOffered ServiceOffered[]
  portfolioItems  PortfolioItem[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model ServiceOffered {
  id         String   @id @default(uuid())
  providerId String   @map("provider_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([providerId, categoryId])
  @@index([providerId])
  @@index([categoryId])
  @@map("services_offered")
}

model Request {
  id             String          @id @default(uuid())
  clientId       String          @map("client_id")
  categoryId     String          @map("category_id")
  title          String
  description    String
  budgetMin      Decimal?        @map("budget_min") @db.Decimal(10, 2)
  budgetMax      Decimal?        @map("budget_max") @db.Decimal(10, 2)
  currency       String          @default("PEN")
  deadline       DateTime?
  urgency        RequestUrgency?
  address        String?
  city           String?
  state          String?
  country        String          @default("Peru")
  latitude       Decimal?        @db.Decimal(10, 8)
  longitude      Decimal?        @db.Decimal(11, 8)
  status         RequestStatus   @default(OPEN)
  proposalsCount Int             @default(0) @map("proposals_count")
  viewsCount     Int             @default(0) @map("views_count")
  expiresAt      DateTime?       @map("expires_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  client        User               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  category      Category           @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  images        RequestImage[]
  proposals     RequestProposal[]
  conversations ChatConversation[]
  savedBy       SavedRequest[]
  transaction   Transaction?

  @@index([clientId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([city])
  @@map("requests")
}

enum RequestUrgency {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

model RequestImage {
  id           String   @id @default(uuid())
  requestId    String   @map("request_id")
  imageUrl     String   @map("image_url")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("request_images")
}

model RequestProposal {
  id            String         @id @default(uuid())
  requestId     String         @map("request_id")
  providerId    String         @map("provider_id")
  price         Decimal        @db.Decimal(10, 2)
  currency      String         @default("PEN")
  estimatedDays Int?           @map("estimated_days")
  message       String
  status        ProposalStatus @default(PENDING)
  isHighlighted Boolean        @default(false) @map("is_highlighted")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  request       Request            @relation(fields: [requestId], references: [id], onDelete: Cascade)
  provider      ProviderProfile    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  conversations ChatConversation[]
  transaction   Transaction?

  @@unique([requestId, providerId])
  @@index([requestId])
  @@index([providerId])
  @@index([status])
  @@map("request_proposals")
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model PortfolioItem {
  id           String   @id @default(uuid())
  providerId   String   @map("provider_id")
  title        String
  description  String?
  imageUrl     String   @map("image_url")
  categoryId   String?  @map("category_id")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([providerId])
  @@map("portfolio_items")
}

model Certification {
  id             String    @id @default(uuid())
  providerId     String    @map("provider_id")
  name           String
  issuer         String?
  issueDate      DateTime? @map("issue_date")
  expiryDate     DateTime? @map("expiry_date")
  certificateUrl String?   @map("certificate_url")
  isVerified     Boolean   @default(false) @map("is_verified")
  createdAt      DateTime  @default(now()) @map("created_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@map("certifications")
}

model Transaction {
  id               String        @id @default(uuid())
  requestId        String        @unique @map("request_id")
  proposalId       String        @unique @map("proposal_id")
  clientId         String        @map("client_id")
  providerId       String        @map("provider_id")
  amount           Decimal       @db.Decimal(10, 2)
  currency         String        @default("PEN")
  platformFee      Decimal       @default(0.00) @map("platform_fee") @db.Decimal(10, 2)
  providerEarnings Decimal       @map("provider_earnings") @db.Decimal(10, 2)
  paymentMethod    String?       @map("payment_method")
  paymentStatus    PaymentStatus @default(PENDING) @map("payment_status")
  stripePaymentId  String?       @map("stripe_payment_id")
  startedAt        DateTime?     @map("started_at")
  completedAt      DateTime?     @map("completed_at")
  createdAt        DateTime      @default(now()) @map("created_at")

  request  Request         @relation(fields: [requestId], references: [id], onDelete: Restrict)
  proposal RequestProposal @relation(fields: [proposalId], references: [id], onDelete: Restrict)
  client   User            @relation(fields: [clientId], references: [id], onDelete: Restrict)
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Restrict)
  review   Review?

  @@index([clientId])
  @@index([providerId])
  @@index([paymentStatus])
  @@map("transactions")
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model Review {
  id                  String   @id @default(uuid())
  transactionId       String   @unique @map("transaction_id")
  reviewerId          String   @map("reviewer_id")
  revieweeId          String   @map("reviewee_id")
  rating              Int
  comment             String?
  qualityRating       Int?     @map("quality_rating")
  punctualityRating   Int?     @map("punctuality_rating")
  communicationRating Int?     @map("communication_rating")
  isVisible           Boolean  @default(true) @map("is_visible")
  createdAt           DateTime @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("ReviewSender", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee    User        @relation("ReviewReceiver", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@index([revieweeId])
  @@index([transactionId])
  @@map("reviews")
}

model ChatConversation {
  id             String    @id @default(uuid())
  requestId      String?   @map("request_id")
  proposalId     String?   @map("proposal_id")
  participant1Id String    @map("participant_1_id")
  participant2Id String    @map("participant_2_id")
  lastMessageAt  DateTime? @map("last_message_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  request      Request?         @relation(fields: [requestId], references: [id], onDelete: Cascade)
  proposal     RequestProposal? @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  participant1 User             @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User             @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages     ChatMessage[]

  @@unique([requestId, participant1Id, participant2Id])
  @@index([participant1Id, participant2Id])
  @@index([requestId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  message        String
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("chat_messages")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model Subscription {
  id                   String             @id @default(uuid())
  providerId           String             @map("provider_id")
  planType             SubscriptionPlan   @map("plan_type")
  startDate            DateTime           @map("start_date")
  endDate              DateTime           @map("end_date")
  amount               Decimal            @db.Decimal(10, 2)
  currency             String             @default("PEN")
  status               SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  createdAt            DateTime           @default(now()) @map("created_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionPlan {
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

model SavedRequest {
  id         String   @id @default(uuid())
  providerId String   @map("provider_id")
  requestId  String   @map("request_id")
  createdAt  DateTime @default(now()) @map("created_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  request  Request         @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([providerId, requestId])
  @@index([providerId])
  @@map("saved_requests")
}
